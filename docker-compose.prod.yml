version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: techletter_api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-api
      CONTENT_SERVICE_BASE_URL: http://content_service:8001
      USER_SERVICE_BASE_URL: http://user_service:8002
      CHATBOT_SERVICE_BASE_URL: http://chatbot_service:8003
      LOG_LEVEL: INFO
      SERVICE_NAME: api-gateway
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      GOOGLE_OAUTH_REDIRECT_URL: https://tech-letter.duckdns.org/api/v1/auth/google/callback
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: tech-letter
      AUTH_LOGIN_SUCCESS_REDIRECT_URL: https://tech-letter.duckdns.org/login/success
      CORS_ALLOWED_ORIGINS: https://tech-letter.duckdns.org
    depends_on:
      content_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
    networks:
      - tech-letter_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`tech-letter.duckdns.org`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=duckdns"
      - "traefik.http.services.api.loadbalancer.server.port=8080"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  content_service:
    build:
      context: .
      dockerfile: Dockerfile.content_service
    container_name: techletter_content_service
    restart: unless-stopped
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    env_file:
      - .env
    environment:
      MONGO_URI: ${MONGO_URI}
      MONGO_DB_NAME: techletter
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-content-service
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_MAX_POLL_INTERVAL_MS: 900000
      CONTENT_SERVICE_PORT: 8001
      LOG_LEVEL: INFO
      SERVICE_NAME: content-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  user_service:
    build:
      context: .
      dockerfile: Dockerfile.user_service
    container_name: techletter_user_service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MONGO_URI: ${MONGO_URI}
      MONGO_DB_NAME: techletter
      USER_SERVICE_PORT: 8002
      LOG_LEVEL: INFO
      SERVICE_NAME: user-service
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-user-service
      KAFKA_MESSAGE_MAX_BYTES: 10485760
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  retryworker:
    build:
      context: .
      dockerfile: Dockerfile.retryworker
    container_name: techletter_retry_worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-retry
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_MAX_POLL_INTERVAL_MS: 3200000
      LOG_LEVEL: INFO
      SERVICE_NAME: retry-worker
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  summary_worker:
    build:
      context: .
      dockerfile: Dockerfile.summary_worker
    container_name: techletter_summary_worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SUMMARY_WORKER_LLM_API_KEY: ${SUMMARY_WORKER_LLM_API_KEY}
      SUMMARY_WORKER_LLM_PROVIDER: google
      SUMMARY_WORKER_LLM_MODEL_NAME: gemini-2.5-flash
      # SUMMARY_WORKER_LLM_PROVIDER: openrouter
      # SUMMARY_WORKER_LLM_MODEL_NAME: google/gemini-2.5-flash
      SUMMARY_WORKER_LLM_TEMPERATURE: 1
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-summary-worker
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_MAX_POLL_INTERVAL_MS: 3200000
      LOG_LEVEL: INFO
      SERVICE_NAME: summary-worker
      SCRAPERAPI_KEY: ${SCRAPERAPI_KEY}
      RENDERER_STRATEGY: scraperapi # [playwright, scraperapi]
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  embedding_worker:
    build:
      context: .
      dockerfile: Dockerfile.embedding_worker
    container_name: techletter_embedding_worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      EMBEDDING_WORKER_LLM_API_KEY: ${EMBEDDING_WORKER_LLM_API_KEY}
      EMBEDDING_WORKER_LLM_PROVIDER: google
      EMBEDDING_WORKER_LLM_MODEL_NAME: gemini-embedding-001
      # EMBEDDING_WORKER_LLM_PROVIDER: openrouter
      # EMBEDDING_WORKER_LLM_MODEL_NAME: google/gemini-embedding-001
      EMBEDDING_WORKER_CHUNK_SIZE: 1000
      EMBEDDING_WORKER_CHUNK_OVERLAP: 200
      MONGO_URI: ${MONGO_URI}
      MONGO_DB_NAME: techletter
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-embedding-worker
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_MAX_POLL_INTERVAL_MS: 3200000
      LOG_LEVEL: INFO
      SERVICE_NAME: embedding-worker
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  chatbot_service:
    build:
      context: .
      dockerfile: Dockerfile.chatbot_service
    container_name: techletter_chatbot_service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      CHATBOT_LLM_API_KEY: ${CHATBOT_LLM_API_KEY}
      CHATBOT_LLM_PROVIDER: google
      CHATBOT_LLM_MODEL_NAME: gemini-2.5-flash
      # CHATBOT_LLM_PROVIDER: openrouter
      # CHATBOT_LLM_MODEL_NAME: google/gemma-3-27b-it:free
      CHATBOT_LLM_TEMPERATURE: 0.7
      CHATBOT_LLM_MAX_RETRIES: 0
      CHATBOT_EMBEDDING_API_KEY: ${CHATBOT_EMBEDDING_API_KEY}
      CHATBOT_EMBEDDING_PROVIDER: google
      CHATBOT_EMBEDDING_MODEL_NAME: gemini-embedding-001
      CHATBOT_RAG_TOP_K: 5
      CHATBOT_RAG_SCORE_THRESHOLD: 0.5
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      QDRANT_COLLECTION_NAME: tech_letter_posts
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: tech-letter-chatbot-service
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      CHATBOT_SERVICE_PORT: 8003
      LOG_LEVEL: INFO
      SERVICE_NAME: chatbot-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tech-letter_default
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  tech-letter_default:
    external: true
